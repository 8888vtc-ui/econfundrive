---
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ECOFUNDRIVE V2.0 - DYNAMIC PAGE GENERATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

import PageLayout from '../../layouts/PageLayout.astro';
import Hero from '../../components/Hero.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ContentSection from '../../components/ContentSection.astro';
import FAQ from '../../components/FAQ.astro';
import CTA from '../../components/CTA.astro';
import Schemas from '../../components/Schemas.astro';

import { siteConfig } from '../../lib/config';
import { generatePageContent } from '../../lib/claude';
import { generateHeroImage } from '../../lib/fluxpro';
import { sanitizeHtml } from '../../lib/sanitize';
import { getActiveKeywords, buildCanonical, validateInternalLinks, findRelated } from '../../lib/keywords';

// Generate static paths using keywords helper
export async function getStaticPaths() {
  const keywords = getActiveKeywords();
  console.log(`üîß Generating ${keywords.length} pages from active keyword set`);
  
  const paths = keywords.map((keyword) => ({
    params: {
      lang: keyword.language,
      slug: keyword.keyword
    },
    props: { keyword }
  }));

  return paths;
}

const { keyword } = Astro.props;

// Generate content using Claude API (at build time)
let pageContent;
try {
  pageContent = await generatePageContent(keyword);
} catch (error) {
  console.error(`Error generating content for ${keyword.keyword}:`, error);
  // Fallback content
  pageContent = {
    title: keyword.keyword.replace(/-/g, ' ').toUpperCase(),
    meta_title: `${keyword.keyword} | ECOFUNDRIVE`,
    meta_description: `Service VTC Tesla premium pour ${keyword.location}. R√©servez votre chauffeur priv√©.`,
    introduction: `Service VTC Tesla premium √† ${keyword.location}.`,
    sections: [],
    faq: [],
    internal_links: [],
    wordcount: 0
  };
}

// Use pre-generated images with fallbacks to generic Riviera images
const heroImagePath = `/images/hero/${keyword.keyword}.jpg`;
const midImagePath = `/images/content/${keyword.keyword}-mid.jpg`;
const endImagePath = `/images/content/${keyword.keyword}-end.jpg`;

// Fallback images for when specific images aren't generated yet
const heroImageFallback = '/images/hero/shared/homepage-riviera-1920w.webp';
const contentImageFallback = '/images/hero/shared/homepage-riviera-1920w.webp';

console.log(`üñºÔ∏è Using images for ${keyword.keyword}:`, {
  hero: heroImagePath,
  mid: midImagePath,
  end: endImagePath
});

// Validate and filter internal links to prevent broken links
if (pageContent.internal_links && pageContent.internal_links.length > 0) {
  const validatedLinks = validateInternalLinks(pageContent.internal_links);
  const removedCount = pageContent.internal_links.length - validatedLinks.length;
  if (removedCount > 0) {
    console.warn(`‚ö†Ô∏è Removed ${removedCount} broken internal links for ${keyword.keyword}`);
  }
  pageContent.internal_links = validatedLinks;
}

// Find related pages for deterministic internal linking
const relatedPages = findRelated(keyword, {
  sameCategory: true,
  sameLocation: false,
  modeBias: keyword.mode === 'A' ? 'B' : undefined, // Mode A pages should link to Mode B for conversions
  limit: 6
});

// Breadcrumb items
const breadcrumbs = [
  { label: keyword.category.toUpperCase(), href: `/${keyword.language}/${keyword.category}` },
  { label: pageContent.title }
];

// FAQ items formatting
const faqItems = pageContent.faq?.map((item: any) => ({
  question: item.question,
  answer: item.answer
})) || [];

// SEO Optimization: Use keyword JSON meta_title if available, fallback to Claude generated
const optimizedMetaTitle = keyword.meta_title || pageContent.meta_title;
const optimizedMetaDescription = keyword.meta_description || pageContent.meta_description;
---

<PageLayout
  title={pageContent.title}
  metaTitle={optimizedMetaTitle}
  metaDescription={optimizedMetaDescription}
  lang={keyword.language}
  canonical={buildCanonical(keyword.language, keyword.keyword)}
  ogImage={heroImagePath}
>
  <!-- Hero Section -->
  <Hero
    title={pageContent.title}
    subtitle={pageContent.introduction?.substring(0, 200) + '...'}
    image={heroImagePath}
    imageAlt={pageContent.title}
  />

  <!-- Breadcrumb -->
  <Breadcrumb items={breadcrumbs} lang={keyword.language} />

  <!-- Introduction -->
  <ContentSection>
    <div set:html={sanitizeHtml(pageContent.introduction)} />
  </ContentSection>

  <!-- CTA Top (Mode B only) -->
  {keyword.mode === 'B' && (
    <CTA
      location="hero"
      lang={keyword.language}
    />
  )}

  <!-- Main Content Sections -->
  {pageContent.sections?.map((section: any, index: number) => (
    <>
      <ContentSection title={section.h2}>
        <div set:html={sanitizeHtml(section.content)} />

        {section.h3?.map((subsection: any) => (
          <div>
            <h3>{subsection.title}</h3>
            <div set:html={sanitizeHtml(subsection.content)} />
          </div>
        ))}

        <!-- Internal Links Integration: Add 2-3 internal links per section -->
        {pageContent.internal_links && pageContent.internal_links.length > 0 && index < 3 && (
          <div class="internal-links-box" style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-left: 4px solid #25D366; border-radius: 8px;">
            <p style="font-size: 0.95rem; line-height: 1.8; margin: 0;">
              {pageContent.internal_links
                .slice(index * 3, index * 3 + 3)
                .map((link: any, linkIndex: number) => (
                  <>
                    {linkIndex > 0 && ' '}
                    <span set:html={sanitizeHtml(link.context.replace(
                      link.anchor,
                      `<a href="${link.url}" style="color: #25D366; font-weight: 600; text-decoration: underline;">${link.anchor}</a>`
                    ))} />
                  </>
                ))
              }
            </p>
          </div>
        )}
      </ContentSection>

      <!-- Mid Image: Insert after section 2 (~40% content) -->
      {index === 1 && (
        <section class="content-image-section">
          <img
            src={midImagePath}
            alt={`${pageContent.title} - D√©couvrez l'exp√©rience`}
            width="1920"
            height="1080"
            loading="lazy"
            class="content-image"
          />
        </section>
      )}
    </>
  ))}

  <!-- CTA Mid (Mode B only) -->
  {keyword.mode === 'B' && (
    <CTA
      location="mid"
      variant="primary"
      lang={keyword.language}
    />
  )}

  <!-- End Image: Before FAQ section (~80% content) -->
  <section class="content-image-section">
    <img
      src={endImagePath}
      alt={`${pageContent.title} - Vivez l'exp√©rience ECOFUNDRIVE`}
      width="1920"
      height="1080"
      loading="lazy"
      class="content-image"
    />
  </section>

  <!-- FAQ Section -->
  {faqItems.length > 0 && (
    <FAQ
      items={faqItems}
      lang={keyword.language}
    />
  )}

  <!-- Related Pages Section (Deterministic Internal Linking) -->
  {relatedPages.length > 0 && (
    <ContentSection>
      <h2>{keyword.language === 'fr' ? 'Articles Connexes' : 'Related Articles'}</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
        {relatedPages.map((related) => (
          <a 
            href={`/${related.language}/${related.keyword}`}
            style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); text-decoration: none; color: inherit; transition: transform 0.2s, box-shadow 0.2s;"
            onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.1)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
          >
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span style="font-size: 0.85rem; padding: 0.25rem 0.75rem; background: {related.mode === 'B' ? 'var(--accent)' : 'var(--accent-blue)'}; color: white; border-radius: 4px; font-weight: 600;">
                {related.mode === 'B' ? (keyword.language === 'fr' ? 'SERVICE' : 'SERVICE') : (keyword.language === 'fr' ? 'GUIDE' : 'GUIDE')}
              </span>
              {related.authority && (
                <span style="font-size: 0.85rem; color: #FFD700;">‚≠ê</span>
              )}
            </div>
            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text);">
              {related.keyword.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
            </h3>
            <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0;">
              üìç {related.location}
            </p>
          </a>
        ))}
      </div>
    </ContentSection>
  )}

  <!-- CTA End (All pages) -->
  <CTA
    location="end"
    lang={keyword.language}
  />

  <!-- JSON-LD Schemas (6 required for SEO) -->

  <!-- 1. Article Schema -->
  <Schemas
    type="article"
    data={{
      title: pageContent.title,
      description: pageContent.meta_description,
      datePublished: new Date().toISOString(),
      dateModified: new Date().toISOString()
    }}
  />

  <!-- 2. LocalBusiness Schema -->
  <Schemas type="organization" />

  <!-- 3. Breadcrumb Schema -->
  <Schemas
    type="breadcrumb"
    data={{ breadcrumbs }}
  />

  <!-- 4. FAQ Schema (always included, fallback to default questions if none provided) -->
  <Schemas
    type="faq"
    data={{
      faqItems: faqItems.length > 0 ? faqItems : [
        {
          question: `Comment r√©server un VTC Tesla pour ${keyword.location} ?`,
          answer: `R√©servation facile via WhatsApp au +33 6 16 55 28 11, par t√©l√©phone ou email. Service ECOFUNDRIVE disponible 24/7 pour ${keyword.location}.`
        },
        {
          question: `Quels sont les tarifs VTC Tesla pour ${keyword.location} ?`,
          answer: `Nos tarifs d√©pendent du v√©hicule et de la distance. Tesla Model 3 √† partir de 70‚Ç¨/h, Model S 100‚Ç¨/h, Model X 120‚Ç¨/h. Devis gratuit pour ${keyword.location}.`
        },
        {
          question: "Pourquoi choisir ECOFUNDRIVE ?",
          answer: "100% flotte Tesla √©lectrique, 5.0‚òÖ sur 26 avis v√©rifi√©s, chauffeurs professionnels bilingues, service premium √©cologique sur la C√¥te d'Azur."
        }
      ]
    }}
  />

  <!-- 5. AggregateRating Schema -->
  <Schemas type="rating" />

  <!-- 6. Service Schema -->
  <Schemas type="service" />
</PageLayout>
