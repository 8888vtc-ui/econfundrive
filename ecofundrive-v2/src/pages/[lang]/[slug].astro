---
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ECOFUNDRIVE V2.0 - DYNAMIC PAGE GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import PageLayout from '../../layouts/PageLayout.astro';
import Hero from '../../components/Hero.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ContentSection from '../../components/ContentSection.astro';
import FAQ from '../../components/FAQ.astro';
import CTA from '../../components/CTA.astro';
import Schemas from '../../components/Schemas.astro';

import { siteConfig } from '../../lib/config';
import { generatePageContent } from '../../lib/claude';
import { generateHeroImage } from '../../lib/fluxpro';
import { sanitizeHtml } from '../../lib/sanitize';

// Import keywords (TEST MODE - single keyword)
import keywordsData from '../../content/keywords/keywords-test.json';

// Generate static paths
export async function getStaticPaths() {
  const paths = keywordsData.keywords.map((keyword) => ({
    params: {
      lang: keyword.language,
      slug: keyword.keyword
    },
    props: { keyword }
  }));

  return paths;
}

const { keyword } = Astro.props;

// Generate content using Claude API (at build time)
let pageContent;
try {
  pageContent = await generatePageContent(keyword);
} catch (error) {
  console.error(`Error generating content for ${keyword.keyword}:`, error);
  // Fallback content
  pageContent = {
    title: keyword.keyword.replace(/-/g, ' ').toUpperCase(),
    meta_title: `${keyword.keyword} | ECOFUNDRIVE`,
    meta_description: `Service VTC Tesla premium pour ${keyword.location}. RÃ©servez votre chauffeur privÃ©.`,
    introduction: `Service VTC Tesla premium Ã  ${keyword.location}.`,
    sections: [],
    faq: [],
    internal_links: [],
    wordcount: 0
  };
}

// Use pre-generated images (3 images generated separately with npm run generate-images)
const heroImagePath = `/images/hero/${keyword.keyword}.jpg`;
const midImagePath = `/images/content/${keyword.keyword}-mid.jpg`;
const endImagePath = `/images/content/${keyword.keyword}-end.jpg`;

console.log(`ðŸ–¼ï¸ Using pre-generated images:`, {
  hero: heroImagePath,
  mid: midImagePath,
  end: endImagePath
});

// Breadcrumb items
const breadcrumbs = [
  { label: keyword.category.toUpperCase(), href: `/${keyword.language}/${keyword.category}` },
  { label: pageContent.title }
];

// FAQ items formatting
const faqItems = pageContent.faq?.map((item: any) => ({
  question: item.question,
  answer: item.answer
})) || [];

// SEO Optimization: Use keyword JSON meta_title if available, fallback to Claude generated
const optimizedMetaTitle = keyword.meta_title || pageContent.meta_title;
const optimizedMetaDescription = keyword.meta_description || pageContent.meta_description;
---

<PageLayout
  title={pageContent.title}
  metaTitle={optimizedMetaTitle}
  metaDescription={optimizedMetaDescription}
  lang={keyword.language}
  canonical={`https://ecofundrive.com${keyword.url}`}
  ogImage={heroImagePath}
>
  <!-- Hero Section -->
  <Hero
    title={pageContent.title}
    subtitle={pageContent.introduction?.substring(0, 200) + '...'}
    image={heroImagePath}
    imageAlt={pageContent.title}
  />

  <!-- Breadcrumb -->
  <Breadcrumb items={breadcrumbs} lang={keyword.language} />

  <!-- Introduction -->
  <ContentSection>
    <div set:html={sanitizeHtml(pageContent.introduction)} />
  </ContentSection>

  <!-- CTA Top (Mode B only) -->
  {keyword.mode === 'B' && (
    <CTA
      location="hero"
      lang={keyword.language}
    />
  )}

  <!-- Main Content Sections -->
  {pageContent.sections?.map((section: any, index: number) => (
    <>
      <ContentSection title={section.h2}>
        <div set:html={sanitizeHtml(section.content)} />

        {section.h3?.map((subsection: any) => (
          <div>
            <h3>{subsection.title}</h3>
            <div set:html={sanitizeHtml(subsection.content)} />
          </div>
        ))}

        <!-- Internal Links Integration: Add 2-3 internal links per section -->
        {pageContent.internal_links && pageContent.internal_links.length > 0 && index < 3 && (
          <div class="internal-links-box" style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-left: 4px solid #25D366; border-radius: 8px;">
            <p style="font-size: 0.95rem; line-height: 1.8; margin: 0;">
              {pageContent.internal_links
                .slice(index * 3, index * 3 + 3)
                .map((link: any, linkIndex: number) => (
                  <>
                    {linkIndex > 0 && ' '}
                    <span set:html={sanitizeHtml(link.context.replace(
                      link.anchor,
                      `<a href="${link.url}" style="color: #25D366; font-weight: 600; text-decoration: underline;">${link.anchor}</a>`
                    ))} />
                  </>
                ))
              }
            </p>
          </div>
        )}
      </ContentSection>

      <!-- Mid Image: Insert after section 2 (~40% content) -->
      {index === 1 && (
        <section class="content-image-section">
          <img
            src={midImagePath}
            alt={`${pageContent.title} - DÃ©couvrez l'expÃ©rience`}
            width="1920"
            height="1080"
            loading="lazy"
            class="content-image"
          />
        </section>
      )}
    </>
  ))}

  <!-- CTA Mid (Mode B only) -->
  {keyword.mode === 'B' && (
    <CTA
      location="mid"
      variant="primary"
      lang={keyword.language}
    />
  )}

  <!-- End Image: Before FAQ section (~80% content) -->
  <section class="content-image-section">
    <img
      src={endImagePath}
      alt={`${pageContent.title} - Vivez l'expÃ©rience ECOFUNDRIVE`}
      width="1920"
      height="1080"
      loading="lazy"
      class="content-image"
    />
  </section>

  <!-- FAQ Section -->
  {faqItems.length > 0 && (
    <FAQ
      items={faqItems}
      lang={keyword.language}
    />
  )}

  <!-- CTA End (All pages) -->
  <CTA
    location="end"
    lang={keyword.language}
  />

  <!-- JSON-LD Schemas (6 required for SEO) -->

  <!-- 1. Article Schema -->
  <Schemas
    type="article"
    data={{
      title: pageContent.title,
      description: pageContent.meta_description,
      datePublished: new Date().toISOString(),
      dateModified: new Date().toISOString()
    }}
  />

  <!-- 2. LocalBusiness Schema -->
  <Schemas type="organization" />

  <!-- 3. Breadcrumb Schema -->
  <Schemas
    type="breadcrumb"
    data={{ breadcrumbs }}
  />

  <!-- 4. FAQ Schema (always included, fallback to default questions if none provided) -->
  <Schemas
    type="faq"
    data={{
      faqItems: faqItems.length > 0 ? faqItems : [
        {
          question: `Comment rÃ©server un VTC Tesla pour ${keyword.location} ?`,
          answer: `RÃ©servation facile via WhatsApp au +33 6 16 55 28 11, par tÃ©lÃ©phone ou email. Service ECOFUNDRIVE disponible 24/7 pour ${keyword.location}.`
        },
        {
          question: `Quels sont les tarifs VTC Tesla pour ${keyword.location} ?`,
          answer: `Nos tarifs dÃ©pendent du vÃ©hicule et de la distance. Tesla Model 3 Ã  partir de 70â‚¬/h, Model S 100â‚¬/h, Model X 120â‚¬/h. Devis gratuit pour ${keyword.location}.`
        },
        {
          question: "Pourquoi choisir ECOFUNDRIVE ?",
          answer: "100% flotte Tesla Ã©lectrique, 5.0â˜… sur 26 avis vÃ©rifiÃ©s, chauffeurs professionnels bilingues, service premium Ã©cologique sur la CÃ´te d'Azur."
        }
      ]
    }}
  />

  <!-- 5. AggregateRating Schema -->
  <Schemas type="rating" />

  <!-- 6. Service Schema -->
  <Schemas type="service" />
</PageLayout>
