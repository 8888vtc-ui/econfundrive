---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import WhatsAppButton from '../components/WhatsAppButton.astro';
import Chatbot from '../components/Chatbot.astro';
import ReviewsDisplay from '../components/ReviewsDisplay.astro';
import { allReviews, aggregateRating } from '../data/reviews.ts';

interface Props {
  title: string;
  description: string;
  currentPage?: string;
  ogImage?: string;
  canonical?: string;
  schema?: any; // Schema.org optionnel par page
  skipBaseSchema?: boolean; // Pour pages qui n'ont pas besoin du schema de base
  breadcrumbItems?: Array<{ name: string; url: string }>; // Breadcrumbs optionnels
}

const {
  title,
  description,
  currentPage = "",
  ogImage = "https://www.ecofundrive.com/assets/img/hero/hero-aeroport-nice.webp",
  canonical,
  schema,
  skipBaseSchema = false,
  breadcrumbItems
} = Astro.props;

const canonicalUrl = canonical || Astro.url.pathname;
const fullCanonical = `https://www.ecofundrive.com${canonicalUrl}`;

// Détection de la langue depuis le chemin
const pathLang = Astro.url.pathname.split('/')[1];
const currentLang = pathLang === 'en' ? 'en' : pathLang === 'it' ? 'it' : pathLang === 'ru' ? 'ru' : 'fr';

// Génération des hreflang
const hreflangLinks = [];
if (currentLang === 'fr') {
  hreflangLinks.push({ lang: 'fr', href: fullCanonical });
  hreflangLinks.push({ lang: 'en', href: fullCanonical.replace(/^\//, '/en/') });
  hreflangLinks.push({ lang: 'it', href: fullCanonical.replace(/^\//, '/it/') });
  hreflangLinks.push({ lang: 'ru', href: fullCanonical.replace(/^\//, '/ru/') });
  hreflangLinks.push({ lang: 'x-default', href: fullCanonical });
} else if (currentLang === 'en') {
  const frPath = Astro.url.pathname.replace('/en', '') || '/';
  hreflangLinks.push({ lang: 'fr', href: `https://www.ecofundrive.com${frPath}` });
  hreflangLinks.push({ lang: 'en', href: fullCanonical });
  hreflangLinks.push({ lang: 'x-default', href: `https://www.ecofundrive.com${frPath}` });
} else if (currentLang === 'it') {
  const frPath = Astro.url.pathname.replace('/it', '') || '/';
  hreflangLinks.push({ lang: 'fr', href: `https://www.ecofundrive.com${frPath}` });
  hreflangLinks.push({ lang: 'it', href: fullCanonical });
  hreflangLinks.push({ lang: 'x-default', href: `https://www.ecofundrive.com${frPath}` });
} else if (currentLang === 'ru') {
  const frPath = Astro.url.pathname.replace('/ru', '') || '/';
  hreflangLinks.push({ lang: 'fr', href: `https://www.ecofundrive.com${frPath}` });
  hreflangLinks.push({ lang: 'ru', href: fullCanonical });
  hreflangLinks.push({ lang: 'x-default', href: `https://www.ecofundrive.com${frPath}` });
}
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <link rel="icon" type="image/svg+xml" href="/assets/img/favicon/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Google Search Console Verification -->
    <meta name="google-site-verification" content="j3W_6acHSoLG44VYoJ7vqzwSzJclmEouNpLwR25fRLU" />
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="ECOFUNDRIVE" />
    
    <!-- Android Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes" />
    
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={fullCanonical} />
    
    <!-- Hreflang tags for multilingual SEO -->
    {hreflangLinks.map(link => (
      <link rel="alternate" hreflang={link.lang} href={link.href} />
    ))}
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/assets/img/favicon/safari-pinned-tab.svg" color="#c9a85e">
    <meta name="msapplication-TileColor" content="#0a0c17">
    <meta name="theme-color" content="#d4af37">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={fullCanonical} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={fullCanonical} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    
    <!-- Preload critical resources for performance -->
    <link rel="preload" href="/assets/fonts/poppins-v20-latin-regular.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
    <link rel="preload" href="/assets/fonts/poppins-v20-latin-600.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
    <link rel="preload" href="/assets/fonts/poppins-v20-latin-700.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
    
    <!-- PREMIUM THEME VTC -->
    <link rel="stylesheet" href="/assets/css/premium-theme.css" />
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="dns-prefetch" href="https://wa.me" />
    
    <!-- Styles CSS modulaires - Critical CSS inline for above-fold content -->
    <link rel="stylesheet" href="/assets/css/base.css" />
    <link rel="stylesheet" href="/assets/css/components.css" />
    <link rel="stylesheet" href="/assets/css/utilities.css" />
    <link rel="stylesheet" href="/assets/css/performance.css" />
    <link rel="stylesheet" href="/assets/css/accessibility.css" />
    <link rel="stylesheet" href="/assets/css/text-colors.css" />
    
    <!-- Defer non-critical JavaScript -->
    <script src="/assets/js/main.js" defer></script>
    
    <!-- Schema.org JSON-LD -->
    {!skipBaseSchema && (
      <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "LocalBusiness",
            "@id": "https://www.ecofundrive.com/#localbusiness",
            "name": "ECOFUNDRIVE – chauffeur privé VTC",
            "url": "https://www.ecofundrive.com/",
            "image": "https://www.ecofundrive.com/assets/img/destinations/vtc-tesla-nice.jpg",
            "telephone": "+33616552811",
            "priceRange": "$$",
            "address": {
              "@type": "PostalAddress",
              "streetAddress": "1001 AVENUE DE LA BATTERIE, MARINA BAIE DES ANGES – LE DUCAL – APP",
              "addressLocality": "Villeneuve-Loubet",
              "postalCode": "06270",
              "addressCountry": "FR"
            },
            "geo": {
              "@type": "GeoCoordinates",
              "latitude": 43.642,
              "longitude": 7.124
            },
            "areaServed": [
              { "@type": "City", "name": "Nice" },
              { "@type": "City", "name": "Cannes" },
              { "@type": "City", "name": "Antibes" },
              { "@type": "City", "name": "Monaco" },
              { "@type": "City", "name": "Saint-Tropez" },
              { "@type": "City", "name": "Fréjus" },
              { "@type": "City", "name": "Sainte-Maxime" }
            ],
            "foundingDate": "2022-04-07",
            "vatID": "FR59912244696",
            "legalName": "ECOFUNDRIVE",
            "serviceType": ["VTC", "Transfert aéroport", "Transport business", "Mise à disposition avec chauffeur"],
            "aggregateRating": {
              "@type": "AggregateRating",
              "ratingValue": aggregateRating.ratingValue,
              "reviewCount": aggregateRating.reviewCount,
              "bestRating": aggregateRating.bestRating,
              "worstRating": aggregateRating.worstRating
            },
            "review": allReviews.map(review => ({
              "@type": "Review",
              "author": {
                "@type": "Person",
                "name": review.author
              },
              "datePublished": review.datePublished,
              "reviewBody": review.reviewBody,
              "reviewRating": {
                "@type": "Rating",
                "ratingValue": review.rating.toString(),
                "bestRating": "5"
              }
            })),
            "sameAs": [
              "https://www.trustindex.io/reviews/ecofundrive.com",
              "https://www.facebook.com/ecofundrive/"
            ],
            "openingHoursSpecification": [{
              "@type": "OpeningHoursSpecification",
              "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
              "opens": "00:00",
              "closes": "23:59"
            }]
          },
          {
            "@type": "WebSite",
            "@id": "https://www.ecofundrive.com/#website",
            "url": "https://www.ecofundrive.com/",
            "name": "ECOFUNDRIVE – chauffeur privé VTC",
            "description": "Chauffeur privé VTC sur la Côte d'Azur (Nice, Cannes, Monaco, Saint-Tropez, Fréjus, Sainte-Maxime). Transferts aéroport, gare, hôtel, domicile, événements.",
            "publisher": {
              "@id": "https://www.ecofundrive.com/#localbusiness"
            }
          }
        ]
      })} />
    )}
    {schema && (
      <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    )}
    
    <!-- Service Worker Registration -->
    <script is:inline>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((reg) => {
              if (import.meta.env.DEV) {
                console.log('Service Worker registered:', reg);
              }
            })
            .catch((err) => {
              if (import.meta.env.DEV) {
                console.error('Service Worker registration failed:', err);
              }
            });
        });
      }
    </script>
    
    <!-- Analytics (optionnel - nécessite PUBLIC_GA4_MEASUREMENT_ID) -->
    {import.meta.env.PUBLIC_GA4_MEASUREMENT_ID && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${import.meta.env.PUBLIC_GA4_MEASUREMENT_ID}`}></script>
        <script is:inline define:vars={{ gaId: import.meta.env.PUBLIC_GA4_MEASUREMENT_ID }}>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaId, {
            'anonymize_ip': true,
            'cookie_flags': 'SameSite=None;Secure'
          });
        </script>
      </>
    )}
    
    <!-- Scripts -->
    <script src="/assets/js/main.js" defer></script>
    <script src="/assets/js/cookies.js" defer></script>
  </head>
  <body data-page={currentPage} style="background-color: #ffffff !important; color: #1a1a1a !important;">
    <a href="#main-content" class="skip-link">Aller au contenu principal</a>
    <Header currentPage={currentPage} />
    {breadcrumbItems && breadcrumbItems.length > 0 && (
      <Breadcrumb items={breadcrumbItems} />
    )}
    <main id="main-content" role="main">
      <slot />
    </main>
    {currentPage !== "avis-clients" && <ReviewsDisplay limit={6} />}
    <Footer />
    <WhatsAppButton />
    <Chatbot />
  </body>
</html>

