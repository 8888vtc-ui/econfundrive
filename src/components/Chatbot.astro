---
// Chatbot VTC - Position fixe, toujours visible
---

<button 
  class="chatbot-toggle" 
  type="button" 
  id="chatbot-toggle"
  aria-label="Ouvrir le chat avec David, votre chauffeur VTC"
  aria-expanded="false">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 2.98.97 4.29L1 23l6.71-1.97c1.31.61 2.75.97 4.29.97 5.52 0 10-4.48 10-10S17.52 2 12 2z" fill="currentColor"/>
    <path d="M8 9h8v2H8V9zm0 4h6v2H8v-2z" fill="currentColor"/>
  </svg>
  <span class="chatbot-label-mobile">À votre service</span>
</button>

<div 
  id="chatbot-container"
  class="chatbot-container"
  role="dialog"
  aria-modal="true"
  aria-labelledby="chatbot-title"
  aria-hidden="true">
  
  <div class="chatbot-header">
    <div class="chatbot-avatar">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="20" cy="20" r="20" fill="#d4af37"/>
        <circle cx="20" cy="16" r="6" fill="#0a0a0a"/>
        <path d="M10 30c0-5.5 4.5-10 10-10s10 4.5 10 10" fill="#0a0a0a"/>
      </svg>
    </div>
    <div class="chatbot-info">
      <h3 id="chatbot-title">David – Chauffeur VTC</h3>
      <p class="chatbot-status">En ligne</p>
    </div>
    <button 
      class="chatbot-close" 
      type="button" 
      id="chatbot-close"
      aria-label="Fermer le chat">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  
  <div class="chatbot-messages" id="chatbot-messages" role="log" aria-live="polite">
    <div class="message bot" data-role="bot">
      <div class="message-content">
        Bonjour ! Je suis David, votre chauffeur privé VTC sur la Côte d'Azur. Comment puis-je vous aider aujourd'hui ? Posez-moi une question ou décrivez votre trajet.
      </div>
    </div>
  </div>
  
  <div class="chatbot-typing" id="chatbot-typing" aria-hidden="true">
    <span></span><span></span><span></span>
  </div>
  
  <form class="chatbot-form" id="chatbot-form" aria-label="Formulaire de message">
    <label for="chatbot-input" class="sr-only">Votre message</label>
    <input 
      type="text"
      id="chatbot-input"
      class="chatbot-input"
      placeholder="Ex: Transfert aéroport Nice → Monaco demain 18h"
      autocomplete="off"
      aria-label="Tapez votre message"
      required>
    <button type="submit" class="chatbot-send" id="chatbot-send" aria-label="Envoyer">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </form>
</div>

<script>
  (function() {
    'use strict';
    
    const toggle = document.getElementById('chatbot-toggle');
    const container = document.getElementById('chatbot-container');
    const closeBtn = document.getElementById('chatbot-close');
    const form = document.getElementById('chatbot-form');
    const input = document.getElementById('chatbot-input');
    const messages = document.getElementById('chatbot-messages');
    const typing = document.getElementById('chatbot-typing');
    
    let isOpen = false;
    let isProcessing = false;
    
    function openChat() {
      isOpen = true;
      container.classList.add('open');
      container.setAttribute('aria-hidden', 'false');
      toggle.setAttribute('aria-expanded', 'true');
      toggle.classList.add('active');
      input?.focus();
      setTimeout(() => {
        if (messages) messages.scrollTop = messages.scrollHeight;
      }, 100);
    }
    
    function closeChat() {
      isOpen = false;
      container.classList.remove('open');
      container.setAttribute('aria-hidden', 'true');
      toggle.setAttribute('aria-expanded', 'false');
      toggle.classList.remove('active');
    }
    
    if (toggle) {
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        if (isOpen) {
          closeChat();
        } else {
          openChat();
        }
      });
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', closeChat);
    }
    
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = input?.value?.trim();
        if (!text || isProcessing) return;
        
        isProcessing = true;
        const sendBtn = document.getElementById('chatbot-send');
        if (sendBtn) sendBtn.disabled = true;
        
        if (messages && input) {
          const userMsg = document.createElement('div');
          userMsg.className = 'message user';
          userMsg.innerHTML = `<div class="message-content">${text}</div>`;
          messages.appendChild(userMsg);
          messages.scrollTop = messages.scrollHeight;
          input.value = '';
        }
        
        if (typing) typing.style.display = 'flex';
        
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 20000);
          
          const response = await fetch('/.netlify/functions/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text }),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (typing) typing.style.display = 'none';
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const data = await response.json();
          const answer = data.answer || "Je suis désolé, je n'ai pas pu générer de réponse. Pouvez-vous reformuler ?";
          
          if (messages) {
            const botMsg = document.createElement('div');
            botMsg.className = 'message bot';
            botMsg.innerHTML = `<div class="message-content">${answer}</div>`;
            messages.appendChild(botMsg);
            messages.scrollTop = messages.scrollHeight;
          }
        } catch (error) {
          if (typing) typing.style.display = 'none';
          if (messages) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'message bot';
            errorMsg.innerHTML = `<div class="message-content">Une erreur s'est produite. Veuillez réessayer ou nous contacter au 06 16 55 28 11.</div>`;
            messages.appendChild(errorMsg);
            messages.scrollTop = messages.scrollHeight;
          }
        } finally {
          isProcessing = false;
          if (sendBtn) sendBtn.disabled = false;
          if (input) input.focus();
        }
      });
    }
    
    document.addEventListener('click', (e) => {
      if (isOpen && 
          container && 
          !container.contains(e.target) && 
          toggle && 
          !toggle.contains(e.target)) {
        closeChat();
      }
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeChat();
      }
    });
  })();
</script>

<style>
  /* Chatbot Toggle - FIXE, TOUJOURS VISIBLE */
  .chatbot-toggle {
    position: fixed !important;
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 10000 !important;
    bottom: 25px;
    right: 25px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #d4af37, #b8941f);
    border: none;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    color: #0a0a0a;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .chatbot-toggle:hover {
    transform: scale(1.1) translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  }

  .chatbot-toggle.active {
    background: linear-gradient(135deg, #b8941f, #d4af37);
  }

  .chatbot-label-mobile {
    display: none;
  }

  /* Chatbot Container */
  .chatbot-container {
    position: fixed !important;
    bottom: 100px;
    right: 25px;
    width: 380px;
    max-width: calc(100vw - 50px);
    max-height: 600px;
    background: rgba(26, 26, 26, 0.98);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(212, 175, 55, 0.3);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    z-index: 10000 !important;
    display: none;
    flex-direction: column;
    overflow: hidden;
    transform: translateY(20px) scale(0.95);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .chatbot-container.open {
    display: flex !important;
    transform: translateY(0) scale(1);
    opacity: 1;
  }

  .chatbot-header {
    background: rgba(10, 10, 10, 0.95);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 2px solid rgba(212, 175, 55, 0.2);
  }

  .chatbot-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #d4af37, #b8941f);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
  }

  .chatbot-info {
    flex: 1;
  }

  .chatbot-info h3 {
    color: #ffffff;
    font-size: 1rem;
    margin: 0 0 4px 0;
    font-weight: 600;
  }

  .chatbot-status {
    color: #d4af37;
    font-size: 0.85rem;
    margin: 0;
    display: flex;
    align-items: center;
  }

  .chatbot-status::before {
    content: '●';
    color: #4ade80;
    font-size: 1rem;
    margin-right: 6px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .chatbot-close {
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s, transform 0.2s;
    border-radius: 4px;
  }

  .chatbot-close:hover {
    color: #d4af37;
    transform: rotate(90deg);
  }

  .chatbot-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 20px;
    scroll-behavior: smooth;
  }

  .chatbot-messages::-webkit-scrollbar {
    width: 6px;
  }

  .chatbot-messages::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
  }

  .chatbot-messages::-webkit-scrollbar-thumb {
    background: rgba(212, 175, 55, 0.3);
    border-radius: 3px;
  }

  .message {
    margin-bottom: 16px;
    max-width: 85%;
    animation: fadeIn 0.3s ease-out;
  }

  .message.user {
    margin-left: auto;
    margin-right: 0;
  }

  .message.bot {
    margin-right: auto;
    margin-left: 0;
  }

  .message-content {
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 0.9rem;
    line-height: 1.5;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  .message.user .message-content {
    background: linear-gradient(135deg, #d4af37, #b8941f);
    color: #0a0a0a;
    border-bottom-right-radius: 4px;
    font-weight: 500;
  }

  .message.bot .message-content {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
    border-bottom-left-radius: 4px;
  }

  .chatbot-typing {
    display: none;
    padding: 12px 20px;
    gap: 6px;
    align-items: center;
  }

  .chatbot-typing span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #d4af37;
    animation: typing 1.4s infinite;
  }

  .chatbot-typing span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .chatbot-typing span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%, 60%, 100% {
      transform: translateY(0);
      opacity: 0.7;
    }
    30% {
      transform: translateY(-10px);
      opacity: 1;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .chatbot-form {
    padding: 12px 16px;
    background: rgba(10, 10, 10, 0.95);
    border-top: 2px solid rgba(212, 175, 55, 0.2);
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .chatbot-input {
    flex: 1;
    background: rgba(26, 26, 26, 0.8);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 24px;
    padding: 10px 16px;
    color: #ffffff;
    font-size: 0.9rem;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .chatbot-input:focus {
    outline: none;
    border-color: #d4af37;
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
  }

  .chatbot-input::placeholder {
    color: #9ca3af;
  }

  .chatbot-send {
    background: linear-gradient(135deg, #d4af37, #b8941f);
    color: #0a0a0a;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    flex-shrink: 0;
  }

  .chatbot-send:hover:not(:disabled) {
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
  }

  .chatbot-send:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* Mobile - Chatbot en haut droite avec texte */
  @media (max-width: 768px) {
    .chatbot-container {
      width: calc(100vw - 20px) !important;
      right: 10px !important;
      top: 80px !important;
      bottom: auto !important;
      max-height: calc(100vh - 100px);
    }

    .chatbot-toggle {
      top: 20px !important;
      right: 20px !important;
      bottom: auto !important;
      width: auto !important;
      height: auto !important;
      min-width: 140px;
      padding: 10px 16px;
      border-radius: 25px;
      flex-direction: row;
      gap: 8px;
    }

    .chatbot-toggle svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .chatbot-label-mobile {
      display: inline-block !important;
      font-size: 0.85rem;
      font-weight: 600;
      color: #0a0a0a;
      white-space: nowrap;
    }
  }
</style>

