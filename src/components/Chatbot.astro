---
// Chatbot AI - Guide touristique expert Côte d'Azur
const chatbotLabel = "VIP Service Guide";
---

<div class="chatbot-container" id="chatbot-container">
  <button 
    class="chatbot-toggle" 
    id="chatbot-toggle"
    aria-label="Ouvrir le guide touristique"
    aria-expanded="false"
    aria-controls="chatbot-window"
  >
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span class="chatbot-label">{chatbotLabel}</span>
  </button>

  <div class="chatbot-window" id="chatbot-window" aria-hidden="true" role="dialog" aria-labelledby="chatbot-title">
    <div class="chatbot-header">
      <h3 id="chatbot-title" class="chatbot-title">{chatbotLabel}</h3>
      <button 
        class="chatbot-close" 
        id="chatbot-close"
        aria-label="Fermer le guide touristique"
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="chatbot-messages" id="chatbot-messages" role="log" aria-live="polite">
      <div class="chatbot-message chatbot-message-bot">
        <div class="message-content">
          <p>Bonjour ! Je suis votre guide touristique expert sur la Côte d'Azur. Je peux vous conseiller sur les meilleurs endroits à visiter, les restaurants, les plages, et bien plus encore. Que souhaitez-vous découvrir ?</p>
        </div>
      </div>
    </div>
    <div class="chatbot-input-container">
      <form class="chatbot-form" id="chatbot-form">
        <input 
          type="text" 
          id="chatbot-input" 
          class="chatbot-input" 
          placeholder="Posez votre question..."
          aria-label="Votre question pour le guide"
          autocomplete="off"
        />
        <button 
          type="submit" 
          class="chatbot-send"
          aria-label="Envoyer votre message"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </form>
      <p class="chatbot-whatsapp-hint">
        Pour les réservations et tarifs, contactez-nous directement sur <a href="https://wa.me/33616552811" target="_blank" rel="noopener">WhatsApp</a>
      </p>
    </div>
  </div>
</div>

<style>
  .chatbot-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: var(--z-chatbot);
  }

  .chatbot-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, var(--color-gold), var(--color-gold-dark));
    color: var(--color-primary-black);
    border: none;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    transition: all var(--transition-normal);
    will-change: transform;
    backface-visibility: hidden;
    min-height: 44px;
  }

  .chatbot-toggle:hover,
  .chatbot-toggle:focus {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 16px rgba(212, 175, 55, 0.5);
  }

  .chatbot-toggle:active {
    transform: translateY(0) scale(1);
  }

  .chatbot-toggle svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .chatbot-label {
    white-space: nowrap;
  }

  .chatbot-window {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 380px;
    max-width: calc(100vw - 40px);
    max-height: calc(100vh - 100px);
    background: var(--color-primary-black);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    display: none;
    flex-direction: column;
    overflow: hidden;
    z-index: calc(var(--z-chatbot) + 1);
  }

  .chatbot-window.open {
    display: flex;
  }

  .chatbot-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-md);
    background: rgba(212, 175, 55, 0.1);
    border-bottom: 1px solid rgba(212, 175, 55, 0.2);
  }

  .chatbot-title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--color-gold);
    margin: 0;
  }

  .chatbot-close {
    background: transparent;
    border: none;
    color: var(--color-gray-light);
    cursor: pointer;
    padding: var(--spacing-xs);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
    min-width: 32px;
    min-height: 32px;
  }

  .chatbot-close:hover,
  .chatbot-close:focus {
    background: rgba(212, 175, 55, 0.2);
    color: var(--color-gold);
  }

  .chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    min-height: 200px;
    max-height: 400px;
  }

  .chatbot-message {
    display: flex;
    gap: var(--spacing-sm);
  }

  .chatbot-message-bot {
    justify-content: flex-start;
  }

  .chatbot-message-user {
    justify-content: flex-end;
  }

  .message-content {
    max-width: 80%;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-md);
    line-height: var(--line-height-normal);
  }

  .chatbot-message-bot .message-content {
    background: rgba(212, 175, 55, 0.1);
    color: var(--color-gray-light);
    border: 1px solid rgba(212, 175, 55, 0.2);
  }

  .chatbot-message-user .message-content {
    background: var(--color-gold);
    color: var(--color-primary-black);
  }

  .chatbot-input-container {
    padding: var(--spacing-md);
    border-top: 1px solid rgba(212, 175, 55, 0.2);
    background: rgba(10, 10, 10, 0.5);
  }

  .chatbot-form {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
  }

  .chatbot-input {
    flex: 1;
    padding: var(--spacing-sm) var(--spacing-md);
    background: rgba(26, 26, 26, 0.8);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: var(--radius-md);
    color: var(--color-white);
    font-size: var(--font-size-base);
    min-height: 44px;
  }

  .chatbot-input:focus {
    outline: none;
    border-color: var(--color-gold);
    box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
  }

  .chatbot-send {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-gold);
    color: var(--color-primary-black);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    min-width: 44px;
    min-height: 44px;
  }

  .chatbot-send:hover,
  .chatbot-send:focus {
    background: var(--color-gold-light);
    transform: scale(1.05);
  }

  .chatbot-whatsapp-hint {
    font-size: var(--font-size-sm);
    color: var(--color-gray);
    text-align: center;
    margin: 0;
  }

  .chatbot-whatsapp-hint a {
    color: var(--color-gold);
    text-decoration: underline;
  }

  /* Mobile */
  @media (max-width: 768px) {
    .chatbot-container {
      top: 20px;
      left: 20px;
      right: auto;
    }

    .chatbot-window {
      top: 80px;
      left: 20px;
      right: 20px;
      width: auto;
      max-width: none;
    }

    .chatbot-toggle {
      padding: 10px 16px;
      font-size: 0.85rem;
    }

    .chatbot-toggle svg {
      width: 18px;
      height: 18px;
    }
  }

  /* Loading state */
  .chatbot-message.loading .message-content::after {
    content: '...';
    animation: dots 1.5s steps(4, end) infinite;
  }

  @keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
  }
</style>

<script>
  (function() {
    'use strict';

    const toggle = document.getElementById('chatbot-toggle');
    const window = document.getElementById('chatbot-window');
    const close = document.getElementById('chatbot-close');
    const form = document.getElementById('chatbot-form');
    const input = document.getElementById('chatbot-input');
    const messages = document.getElementById('chatbot-messages');

    if (!toggle || !window || !form || !input || !messages) return;

    function openChatbot() {
      window.classList.add('open');
      window.setAttribute('aria-hidden', 'false');
      toggle.setAttribute('aria-expanded', 'true');
      input.focus();
    }

    function closeChatbot() {
      window.classList.remove('open');
      window.setAttribute('aria-hidden', 'true');
      toggle.setAttribute('aria-expanded', 'false');
    }

    function addMessage(text, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chatbot-message ${isUser ? 'chatbot-message-user' : 'chatbot-message-bot'}`;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      const p = document.createElement('p');
      p.textContent = text;
      contentDiv.appendChild(p);
      
      messageDiv.appendChild(contentDiv);
      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight;
    }

    function addLoadingMessage() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chatbot-message chatbot-message-bot loading';
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.textContent = '';
      messageDiv.appendChild(contentDiv);
      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight;
      return messageDiv;
    }

    function removeLoadingMessage(loadingMsg) {
      if (loadingMsg && loadingMsg.parentNode) {
        loadingMsg.parentNode.removeChild(loadingMsg);
      }
    }

    toggle.addEventListener('click', openChatbot);
    close?.addEventListener('click', closeChatbot);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userMessage = input.value.trim();
      if (!userMessage) return;

      addMessage(userMessage, true);
      input.value = '';
      
      const loadingMsg = addLoadingMessage();

      try {
        const response = await fetch('/.netlify/functions/chatbot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: userMessage })
        });

        const data = await response.json();
        removeLoadingMessage(loadingMsg);

        if (data.answer) {
          addMessage(data.answer);
          
          if (data.hasBookingInfo && data.whatsappLink) {
            setTimeout(() => {
              const whatsappMsg = document.createElement('div');
              whatsappMsg.className = 'chatbot-message chatbot-message-bot';
              const contentDiv = document.createElement('div');
              contentDiv.className = 'message-content';
              const p = document.createElement('p');
              p.innerHTML = `Pour finaliser votre réservation, <a href="${data.whatsappLink}" target="_blank" rel="noopener" style="color: var(--color-gold); text-decoration: underline;">contactez-moi sur WhatsApp</a> !`;
              contentDiv.appendChild(p);
              whatsappMsg.appendChild(contentDiv);
              messages.appendChild(whatsappMsg);
              messages.scrollTop = messages.scrollHeight;
            }, 500);
          }
        } else {
          addMessage('Désolé, une erreur est survenue. Contactez-moi directement sur WhatsApp pour plus d\'informations.');
        }
      } catch (error) {
        console.error('Chatbot error:', error);
        removeLoadingMessage(loadingMsg);
        addMessage('Désolé, je ne peux pas répondre pour le moment. Contactez-moi directement sur WhatsApp au 06 16 55 28 11.');
      }
    });

    // Fermer avec Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && window.classList.contains('open')) {
        closeChatbot();
      }
    });
  })();
</script>

