---
// Chatbot VTC - Guide touristique, pas fixe
---

<button 
  class="chatbot-toggle" 
  type="button" 
  id="chatbot-toggle"
  aria-label="Ouvrir le chat avec David, votre guide touristique"
  aria-expanded="false">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 2.98.97 4.29L1 23l6.71-1.97c1.31.61 2.75.97 4.29.97 5.52 0 10-4.48 10-10S17.52 2 12 2z" fill="currentColor"/>
    <path d="M8 9h8v2H8V9zm0 4h6v2H8v-2z" fill="currentColor"/>
  </svg>
  <span class="chatbot-label-mobile">VIP Service Guide</span>
</button>

<div 
  id="chatbot-container"
  class="chatbot-container"
  role="dialog"
  aria-modal="true"
  aria-labelledby="chatbot-title"
  aria-hidden="true">
  
  <div class="chatbot-header">
    <div class="chatbot-avatar">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="20" cy="20" r="20" fill="#d4af37"/>
        <circle cx="20" cy="16" r="6" fill="#0a0a0a"/>
        <path d="M10 30c0-5.5 4.5-10 10-10s10 4.5 10 10" fill="#0a0a0a"/>
      </svg>
    </div>
    <div class="chatbot-info">
      <h3 id="chatbot-title">David – Guide Touristique</h3>
      <p class="chatbot-status">En ligne</p>
    </div>
    <button 
      class="chatbot-close" 
      type="button" 
      id="chatbot-close"
      aria-label="Fermer le chat">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  
  <div class="chatbot-messages" id="chatbot-messages" role="log" aria-live="polite">
    <div class="message bot" data-role="bot">
      <div class="message-content">
        Bonjour ! Je suis David, votre guide touristique sur la Côte d'Azur. Je peux vous conseiller sur les visites, restaurants, plages et activités. Pour réserver un trajet, contactez-moi sur WhatsApp au 06 16 55 28 11 !
      </div>
    </div>
  </div>
  
  <div class="chatbot-typing" id="chatbot-typing" aria-hidden="true">
    <span></span><span></span><span></span>
  </div>
  
  <form class="chatbot-form" id="chatbot-form" aria-label="Formulaire de message">
    <label for="chatbot-input" class="sr-only">Votre message</label>
    <input 
      type="text"
      id="chatbot-input"
      class="chatbot-input"
      placeholder="Ex: Quels sont les meilleurs restaurants à Nice ?"
      autocomplete="off"
      aria-label="Tapez votre message"
      required>
    <button type="submit" class="chatbot-send" id="chatbot-send" aria-label="Envoyer">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </form>
</div>

<script>
  (function() {
    'use strict';
    
    const toggle = document.getElementById('chatbot-toggle');
    const container = document.getElementById('chatbot-container');
    const closeBtn = document.getElementById('chatbot-close');
    const form = document.getElementById('chatbot-form');
    const input = document.getElementById('chatbot-input');
    const messages = document.getElementById('chatbot-messages');
    const typing = document.getElementById('chatbot-typing');
    
    let isOpen = false;
    let isProcessing = false;
    
    function openChat() {
      isOpen = true;
      container.classList.add('open');
      container.setAttribute('aria-hidden', 'false');
      toggle.setAttribute('aria-expanded', 'true');
      toggle.classList.add('active');
      input?.focus();
      setTimeout(() => {
        if (messages) messages.scrollTop = messages.scrollHeight;
      }, 100);
    }
    
    function closeChat() {
      isOpen = false;
      container.classList.remove('open');
      container.setAttribute('aria-hidden', 'true');
      toggle.setAttribute('aria-expanded', 'false');
      toggle.classList.remove('active');
    }
    
    if (toggle) {
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        if (isOpen) {
          closeChat();
        } else {
          openChat();
        }
      });
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', closeChat);
    }
    
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = input?.value?.trim();
        if (!text || isProcessing) return;
        
        isProcessing = true;
        const sendBtn = document.getElementById('chatbot-send');
        if (sendBtn) sendBtn.disabled = true;
        
        if (messages && input) {
          const userMsg = document.createElement('div');
          userMsg.className = 'message user';
          userMsg.innerHTML = `<div class="message-content">${text}</div>`;
          messages.appendChild(userMsg);
          messages.scrollTop = messages.scrollHeight;
          input.value = '';
        }
        
        if (typing) typing.style.display = 'flex';
        
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 20000);
          
          const response = await fetch('/.netlify/functions/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text }),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (typing) typing.style.display = 'none';
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const data = await response.json();
          const answer = data.answer || "Je suis désolé, je n'ai pas pu générer de réponse. Contactez-moi sur WhatsApp au 06 16 55 28 11 !";
          
          if (messages) {
            const botMsg = document.createElement('div');
            botMsg.className = 'message bot';
            
            if (data.hasBookingInfo && data.whatsappLink) {
              window.open(data.whatsappLink, '_blank');
            }
            
            botMsg.innerHTML = `<div class="message-content">${answer}</div>`;
            messages.appendChild(botMsg);
            messages.scrollTop = messages.scrollHeight;
          }
        } catch (error) {
          if (typing) typing.style.display = 'none';
          if (messages) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'message bot';
            errorMsg.innerHTML = `<div class="message-content">Une erreur s'est produite. Contactez-moi sur WhatsApp au 06 16 55 28 11 !</div>`;
            messages.appendChild(errorMsg);
            messages.scrollTop = messages.scrollHeight;
          }
        } finally {
          isProcessing = false;
          if (sendBtn) sendBtn.disabled = false;
          if (input) input.focus();
        }
      });
    }
    
    document.addEventListener('click', (e) => {
      if (isOpen && 
          container && 
          !container.contains(e.target) && 
          toggle && 
          !toggle.contains(e.target)) {
        closeChat();
      }
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeChat();
      }
    });
  })();
</script>

<style>
  .chatbot-toggle {
    position: fixed !important;
    top: 80px !important;
    left: 20px !important;
    right: auto !important;
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    align-items: center !important;
    gap: 8px !important;
    padding: 10px 16px !important;
    background: linear-gradient(135deg, #d4af37, #b8941f) !important;
    color: #0a0a0a !important;
    border: none !important;
    border-radius: 25px !important;
    cursor: pointer !important;
    font-weight: 600 !important;
    font-size: 0.85rem !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    z-index: 9999 !important;
    transition: transform 0.2s, box-shadow 0.2s !important;
    min-height: 44px !important; /* WCAG 2.1 AA */
    min-width: 44px !important; /* WCAG 2.1 AA */
  }

  .chatbot-toggle:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  }

  .chatbot-toggle.active {
    background: linear-gradient(135deg, #b8941f, #d4af37);
  }

  .chatbot-toggle svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .chatbot-label-mobile {
    display: inline-block;
  }

  .chatbot-container {
    position: fixed !important;
    top: 140px !important;
    left: 20px !important;
    right: auto !important;
    width: 380px !important;
    max-width: calc(100vw - 40px) !important;
    max-height: 500px !important;
    background: rgba(26, 26, 26, 0.98) !important;
    backdrop-filter: blur(20px) !important;
    border: 2px solid rgba(212, 175, 55, 0.3) !important;
    border-radius: 16px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6) !important;
    z-index: 9998 !important;
    display: none !important;
    flex-direction: column !important;
    overflow: hidden !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .chatbot-container.open {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .chatbot-header {
    background: rgba(10, 10, 10, 0.95);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 2px solid rgba(212, 175, 55, 0.2);
  }

  .chatbot-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #d4af37, #b8941f);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .chatbot-info h3 {
    color: #ffffff;
    font-size: 1rem;
    margin: 0 0 4px 0;
    font-weight: 600;
  }

  .chatbot-status {
    color: #d4af37;
    font-size: 0.85rem;
    margin: 0;
  }

  .chatbot-status::before {
    content: '●';
    color: #4ade80;
    margin-right: 6px;
  }

  .chatbot-close {
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 8px;
    margin-left: auto;
  }

  .chatbot-close:hover {
    color: #d4af37;
  }

  .chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .message {
    margin-bottom: 16px;
    max-width: 85%;
  }

  .message.user {
    margin-left: auto;
  }

  .message-content {
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .message.user .message-content {
    background: linear-gradient(135deg, #d4af37, #b8941f);
    color: #0a0a0a;
  }

  .message.bot .message-content {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
  }

  .chatbot-typing {
    display: none;
    padding: 12px 20px;
    gap: 6px;
  }

  .chatbot-typing span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #d4af37;
  }

  .chatbot-form {
    padding: 12px 16px;
    background: rgba(10, 10, 10, 0.95);
    border-top: 2px solid rgba(212, 175, 55, 0.2);
    display: flex;
    gap: 10px;
  }

  .chatbot-input {
    flex: 1;
    background: rgba(26, 26, 26, 0.8);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 24px;
    padding: 10px 16px;
    color: #ffffff;
    font-size: 0.9rem;
  }

  .chatbot-input:focus {
    outline: none;
    border-color: #d4af37;
  }

  .chatbot-send {
    background: linear-gradient(135deg, #d4af37, #b8941f);
    color: #0a0a0a;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .chatbot-send:hover:not(:disabled) {
    transform: scale(1.1);
  }

  .chatbot-send:disabled {
    opacity: 0.6;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

         @media (max-width: 768px) {
           .chatbot-toggle {
             position: fixed !important;
             top: 100px !important;
             left: 50% !important;
             transform: translateX(-50%) !important;
             right: auto !important;
             font-size: 0.95rem !important;
             padding: 12px 20px !important;
             font-weight: 700 !important;
             z-index: 9999 !important;
             min-height: 48px !important;
             min-width: auto !important;
             box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5) !important;
             border: 2px solid rgba(255, 255, 255, 0.2) !important;
           }

           .chatbot-container {
             position: fixed !important;
             top: 160px !important; /* 60px en dessous du toggle */
             left: 50% !important;
             transform: translateX(-50%) !important;
             right: auto !important;
             width: calc(100vw - 20px) !important;
             max-width: 400px !important;
             max-height: calc(100vh - 180px) !important;
             z-index: 9998 !important;
           }
         }
</style>

