---
// Chatbot AI - Guide touristique expert Côte d'Azur
const chatbotLabel = "VIP Service Guide";
---

<div class="chatbot-container" id="chatbot-container">
  <button 
    class="chatbot-toggle" 
    id="chatbot-toggle"
    aria-label="Ouvrir le guide touristique"
    aria-expanded="false"
    aria-controls="chatbot-window"
  >
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span class="chatbot-label">{chatbotLabel}</span>
  </button>

  <div class="chatbot-window" id="chatbot-window" aria-hidden="true" role="dialog" aria-labelledby="chatbot-title">
    <div class="chatbot-header">
      <h3 id="chatbot-title" class="chatbot-title">{chatbotLabel}</h3>
      <button 
        class="chatbot-close" 
        id="chatbot-close"
        aria-label="Fermer le guide touristique"
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="chatbot-messages" id="chatbot-messages" role="log" aria-live="polite">
      <div class="chatbot-message chatbot-message-bot">
        <div class="message-content">
          <p>Bonjour ! Je suis votre guide touristique expert sur la Côte d'Azur. Je peux vous conseiller sur les meilleurs endroits à visiter, les restaurants, les plages, et bien plus encore. Que souhaitez-vous découvrir ?</p>
        </div>
      </div>
    </div>
    <div class="chatbot-input-container">
      <form class="chatbot-form" id="chatbot-form">
        <input 
          type="text" 
          id="chatbot-input" 
          class="chatbot-input" 
          placeholder="Posez votre question..."
          aria-label="Votre question pour le guide"
          autocomplete="off"
        />
        <button 
          type="submit" 
          class="chatbot-send"
          aria-label="Envoyer votre message"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </form>
      <p class="chatbot-whatsapp-hint">
        Pour les réservations et tarifs, contactez-nous directement sur <a href="https://wa.me/33616552811" target="_blank" rel="noopener">WhatsApp</a>
      </p>
    </div>
  </div>
</div>

<style>
  .chatbot-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
  }

  .chatbot-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, var(--color-gold), var(--color-gold-dark));
    color: var(--color-primary-black);
    border: none;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
    backface-visibility: hidden;
    min-height: 44px;
    min-width: 44px;
  }

  .chatbot-toggle:hover,
  .chatbot-toggle:focus {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 16px rgba(212, 175, 55, 0.5);
    outline: none;
  }

  .chatbot-toggle:active {
    transform: translateY(0) scale(1);
  }

  .chatbot-toggle:focus-visible {
    outline: 3px solid var(--color-white);
    outline-offset: 2px;
  }

  .chatbot-toggle svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .chatbot-label {
    white-space: nowrap;
  }

  .chatbot-window {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 380px;
    max-width: calc(100vw - 40px);
    max-height: calc(100vh - 120px);
    background: var(--color-primary-black);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: var(--radius-lg);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    display: none;
    flex-direction: column;
    overflow: hidden;
    z-index: 10000;
  }

  .chatbot-window.open {
    display: flex;
  }

  .chatbot-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-md);
    background: rgba(212, 175, 55, 0.1);
    border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    flex-shrink: 0;
  }

  .chatbot-title {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: #ffffff !important;
    margin: 0;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }

  .chatbot-close {
    background: transparent;
    border: none;
    color: var(--color-gray-light);
    cursor: pointer;
    padding: var(--spacing-xs);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
    min-width: 44px;
    min-height: 44px;
  }

  .chatbot-close:hover,
  .chatbot-close:focus {
    background: rgba(212, 175, 55, 0.2);
    color: var(--color-gold);
    outline: none;
  }

  .chatbot-close:focus-visible {
    outline: 2px solid var(--color-gold);
    outline-offset: 2px;
  }

  .chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    min-height: 200px;
    max-height: 400px;
    -webkit-overflow-scrolling: touch;
    background: rgba(10, 10, 10, 0.9);
  }

  /* Forcer tous les textes à être blanc clair */
  .chatbot-messages * {
    color: #ffffff !important;
  }

  .chatbot-messages p,
  .chatbot-messages span,
  .chatbot-messages div,
  .chatbot-messages li {
    color: #ffffff !important;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
  }

  .chatbot-message {
    display: flex;
    gap: var(--spacing-sm);
  }

  .chatbot-message-bot {
    justify-content: flex-start;
  }

  .chatbot-message-user {
    justify-content: flex-end;
  }

  .message-content {
    max-width: 80%;
    padding: 14px 18px;
    border-radius: var(--radius-md);
    line-height: 1.7;
    word-wrap: break-word;
    font-size: 15px;
  }

  .message-content p {
    margin: 0;
    color: #ffffff !important;
    font-size: inherit;
    line-height: inherit;
    font-weight: 500;
  }

  .message-content a {
    color: #ffd700 !important;
    text-decoration: underline;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .message-content a:hover {
    color: #ffed4e !important;
  }

  .message-content * {
    color: #ffffff !important;
  }

  .chatbot-message-bot .message-content {
    background: rgba(212, 175, 55, 0.25);
    color: #ffffff !important;
    border: 1px solid rgba(212, 175, 55, 0.5);
    font-size: 15px;
    font-weight: 500;
    line-height: 1.7;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
  }

  .chatbot-message-bot .message-content p,
  .chatbot-message-bot .message-content span,
  .chatbot-message-bot .message-content div {
    color: #ffffff !important;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
  }

  .chatbot-message-user .message-content {
    background: var(--color-gold);
    color: #1a1a1a !important;
  }

  .chatbot-message-user .message-content p,
  .chatbot-message-user .message-content span,
  .chatbot-message-user .message-content div {
    color: #1a1a1a !important;
  }

  .chatbot-input-container {
    padding: var(--spacing-md);
    border-top: 1px solid rgba(212, 175, 55, 0.2);
    background: rgba(10, 10, 10, 0.5);
    flex-shrink: 0;
  }

  .chatbot-form {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
  }

  .chatbot-input {
    flex: 1;
    padding: 12px var(--spacing-md);
    background: rgba(26, 26, 26, 0.8);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: var(--radius-md);
    color: var(--color-white);
    font-size: 16px;
    min-height: 44px;
    font-family: inherit;
  }

  .chatbot-input:focus {
    outline: none;
    border-color: var(--color-gold);
    box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
  }

  .chatbot-send {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-gold);
    color: var(--color-primary-black);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    min-width: 44px;
    min-height: 44px;
    flex-shrink: 0;
  }

  .chatbot-send:hover,
  .chatbot-send:focus {
    background: var(--color-gold-light);
    transform: scale(1.05);
    outline: none;
  }

  .chatbot-send:active {
    transform: scale(0.95);
  }

  .chatbot-send:focus-visible {
    outline: 2px solid var(--color-white);
    outline-offset: 2px;
  }

  .chatbot-whatsapp-hint {
    font-size: var(--font-size-sm);
    color: #ffffff !important;
    text-align: center;
    margin: 0;
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  }

  .chatbot-whatsapp-hint a {
    color: #ffd700 !important;
    text-decoration: underline;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  /* Mobile - Positionnement centré pour ne pas cacher le menu */
  @media (max-width: 768px) {
    .chatbot-container {
      /* Centré horizontalement et verticalement */
      top: 50%;
      left: 50%;
      right: auto;
      transform: translate(-50%, -50%);
      z-index: 9998;
    }

    .chatbot-window {
      /* Fenêtre réduite et centrée */
      top: 50%;
      left: 50%;
      right: auto;
      transform: translate(-50%, -50%);
      width: 90vw;
      max-width: 350px;
      max-height: 60vh; /* Réduit pour ne pas bloquer l'écran */
      z-index: 9999;
      position: fixed !important;
    }

    .chatbot-toggle {
      padding: 10px 16px;
      font-size: 0.85rem;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .chatbot-toggle svg {
      width: 18px;
      height: 18px;
    }

    .chatbot-messages {
      max-height: 250px; /* Réduit de 300px */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* S'assurer que le formulaire est accessible */
    .chatbot-form {
      touch-action: manipulation;
    }

    .chatbot-send {
      min-width: 44px;
      min-height: 44px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(212, 175, 55, 0.3);
      padding: var(--spacing-xs);
    }

    .chatbot-input {
      font-size: 14px !important; /* Réduit de 16px */
      touch-action: manipulation;
      padding: 10px var(--spacing-sm);
      min-height: 40px;
    }

    .chatbot-input-container {
      position: relative;
      z-index: 1;
      padding: var(--spacing-sm); /* Réduit */
    }

    /* Réduire la taille du header */
    .chatbot-header {
      padding: var(--spacing-sm);
    }

    .chatbot-title {
      font-size: 0.9rem;
    }
  }

  /* Loading state */
  .chatbot-message.loading .message-content::after {
    content: '...';
    animation: dots 1.5s steps(4, end) infinite;
  }

  @keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
  }
</style>

<script>
  (function() {
    'use strict';

    // Attendre que le DOM soit chargé
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initChatbot);
    } else {
      initChatbot();
    }

    function initChatbot() {
      const toggle = document.getElementById('chatbot-toggle');
      const window = document.getElementById('chatbot-window');
      const close = document.getElementById('chatbot-close');
      const form = document.getElementById('chatbot-form');
      const input = document.getElementById('chatbot-input');
      const messages = document.getElementById('chatbot-messages');
      const sendButton = form?.querySelector('.chatbot-send');

      if (!toggle || !window || !form || !input || !messages) {
        console.error('Chatbot elements not found');
        return;
      }

      // Variable pour éviter la fermeture lors du tap sur le formulaire
      let isFormInteraction = false;

      function openChatbot() {
        window.classList.add('open');
        window.setAttribute('aria-hidden', 'false');
        toggle.setAttribute('aria-expanded', 'true');
        // Sur mobile, ne pas focus immédiatement pour éviter le scroll
        if (window.innerWidth > 768) {
          setTimeout(() => {
            input.focus();
          }, 100);
        }
      }

      function closeChatbot() {
        window.classList.remove('open');
        window.setAttribute('aria-hidden', 'true');
        toggle.setAttribute('aria-expanded', 'false');
        input.blur();
        isFormInteraction = false;
      }

      function addMessage(text, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chatbot-message ${isUser ? 'chatbot-message-user' : 'chatbot-message-bot'}`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        const p = document.createElement('p');
        p.textContent = text;
        p.style.color = isUser ? '#1a1a1a' : '#ffffff';
        p.style.textShadow = isUser ? 'none' : '0 1px 3px rgba(0, 0, 0, 0.7)';
        p.style.fontWeight = '500';
        contentDiv.appendChild(p);
        
        messageDiv.appendChild(contentDiv);
        messages.appendChild(messageDiv);
        
        // Scroll avec un petit délai pour s'assurer que le message est rendu
        setTimeout(() => {
          messages.scrollTop = messages.scrollHeight;
        }, 50);
      }

      function addLoadingMessage() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chatbot-message chatbot-message-bot loading';
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = '';
        messageDiv.appendChild(contentDiv);
        messages.appendChild(messageDiv);
        setTimeout(() => {
          messages.scrollTop = messages.scrollHeight;
        }, 50);
        return messageDiv;
      }

      function removeLoadingMessage(loadingMsg) {
        if (loadingMsg && loadingMsg.parentNode) {
          loadingMsg.parentNode.removeChild(loadingMsg);
        }
      }

      async function sendMessage() {
        const userMessage = input.value.trim();
        if (!userMessage) {
          if (window.innerWidth > 768) {
            input.focus();
          }
          return;
        }

        addMessage(userMessage, true);
        input.value = '';
        
        // Sur mobile, ne pas blur immédiatement
        if (window.innerWidth > 768) {
          input.blur();
        }
        
        const loadingMsg = addLoadingMessage();

        try {
          const response = await fetch('/.netlify/functions/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMessage })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          removeLoadingMessage(loadingMsg);

          if (data.answer) {
            addMessage(data.answer);
            
            if (data.hasBookingInfo && data.whatsappLink) {
              setTimeout(() => {
                const whatsappMsg = document.createElement('div');
                whatsappMsg.className = 'chatbot-message chatbot-message-bot';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                const p = document.createElement('p');
                p.style.color = '#ffffff';
                p.style.textShadow = '0 1px 3px rgba(0, 0, 0, 0.7)';
                p.style.fontWeight = '500';
                p.innerHTML = `Pour finaliser votre réservation, <a href="${data.whatsappLink}" target="_blank" rel="noopener" style="color: #ffd700 !important; text-decoration: underline; font-weight: 600; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">contactez-moi sur WhatsApp</a> !`;
                contentDiv.appendChild(p);
                whatsappMsg.appendChild(contentDiv);
                messages.appendChild(whatsappMsg);
                setTimeout(() => {
                  messages.scrollTop = messages.scrollHeight;
                }, 50);
              }, 500);
            }
          } else {
            addMessage('Désolé, une erreur est survenue. Contactez-moi directement sur WhatsApp pour plus d\'informations.');
          }
        } catch (error) {
          console.error('Chatbot error:', error);
          removeLoadingMessage(loadingMsg);
          addMessage('Désolé, je ne peux pas répondre pour le moment. Contactez-moi directement sur WhatsApp au 06 16 55 28 11.');
        }
        
        // Remettre le focus sur l'input après la réponse (seulement sur desktop)
        if (window.innerWidth > 768) {
          setTimeout(() => {
            input.focus();
          }, 100);
        }
      }

      // Event listeners
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        if (window.classList.contains('open')) {
          closeChatbot();
        } else {
          openChatbot();
        }
      });

      // Support touch pour mobile
      toggle.addEventListener('touchend', (e) => {
        e.stopPropagation();
        e.preventDefault();
        if (window.classList.contains('open')) {
          closeChatbot();
        } else {
          openChatbot();
        }
      });

      close?.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        closeChatbot();
      });

      close?.addEventListener('touchend', (e) => {
        e.stopPropagation();
        e.preventDefault();
        closeChatbot();
      });

      // Gestion du formulaire - Submit
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        isFormInteraction = true;
        await sendMessage();
        // Réinitialiser après un court délai
        setTimeout(() => {
          isFormInteraction = false;
        }, 300);
      });

      // Bouton send - Click et Touch
      if (sendButton) {
        sendButton.addEventListener('click', async (e) => {
          e.stopPropagation();
          e.preventDefault();
          isFormInteraction = true;
          await sendMessage();
          setTimeout(() => {
            isFormInteraction = false;
          }, 300);
        });

        sendButton.addEventListener('touchend', async (e) => {
          e.stopPropagation();
          e.preventDefault();
          isFormInteraction = true;
          await sendMessage();
          setTimeout(() => {
            isFormInteraction = false;
          }, 300);
        });
      }

      // Input - Enter key
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          e.stopPropagation();
          isFormInteraction = true;
          sendMessage();
          setTimeout(() => {
            isFormInteraction = false;
          }, 300);
        }
      });

      // Fermer en cliquant en dehors (mais pas lors d'une interaction avec le formulaire)
      document.addEventListener('click', (e) => {
        if (window.classList.contains('open') && !isFormInteraction) {
          const isClickInside = window.contains(e.target) || toggle.contains(e.target);
          if (!isClickInside) {
            closeChatbot();
          }
        }
      });

      // Support touch pour fermer en dehors
      document.addEventListener('touchend', (e) => {
        if (window.classList.contains('open') && !isFormInteraction) {
          const isTouchInside = window.contains(e.target) || toggle.contains(e.target);
          if (!isTouchInside) {
            closeChatbot();
          }
        }
      });

      // Fermer avec Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && window.classList.contains('open')) {
          closeChatbot();
        }
      });

      // Empêcher la fermeture lors du scroll sur mobile
      messages.addEventListener('touchstart', (e) => {
        e.stopPropagation();
      });

      messages.addEventListener('touchmove', (e) => {
        e.stopPropagation();
      });

      // Empêcher la propagation des événements du formulaire
      form.addEventListener('touchstart', (e) => {
        e.stopPropagation();
        isFormInteraction = true;
      });

      form.addEventListener('touchend', (e) => {
        e.stopPropagation();
      });
    }
  })();
</script>
