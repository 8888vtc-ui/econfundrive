---
import BaseLayout from '../layouts/BaseLayout.astro';
import SchemaOrg from '../components/SchemaOrg.astro';

const title = "Réservation chauffeur VTC Côte d'Azur | Devis rapide en ligne";
const description = "Demande de réservation VTC en ligne sur la Côte d'Azur : Nice, Cannes, Monaco, Saint‑Tropez, aéroports Nice NCE &amp; Cannes‑Mandelieu. Devis rapide sans paiement en ligne, avec un délai minimum de 4h avant le départ. Réponse prioritaire par téléphone ou WhatsApp pour les demandes urgentes (moins de 4h).";
const canonical = "/reservation";

const faqItems = [
  {
    question: "La demande de réservation m'engage‑t‑elle immédiatement ?",
    answer: "Non, le formulaire permet d'obtenir un prix indicatif et une confirmation de disponibilité. La réservation est réellement confirmée une fois que vous avez validé la proposition reçue (par téléphone, message ou retour écrit)."
  },
  {
    question: "Sous quel délai vais‑je recevoir une réponse ?",
    answer: "Les demandes sont traitées le plus rapidement possible, en général dans un délai rapide pendant les horaires d'activité. Pour les demandes urgentes, l'appel téléphonique ou WhatsApp reste le canal prioritaire."
  },
  {
    question: "Puis‑je modifier une réservation déjà effectuée ?",
    answer: "Oui, dans la limite des disponibilités. En cas de changement d'heure, d'adresse ou de nombre de passagers, il suffit de reprendre contact dès que possible pour ajuster la réservation et, si besoin, le tarif."
  },
  {
    question: "Comment annuler un trajet réservé ?",
    answer: "L'annulation peut se faire en répondant au message de confirmation ou en contactant directement le chauffeur. Les conditions applicables sont précisées sur la page Tarifs (politique d'annulation)."
  },
  {
    question: "Quelles informations sont les plus importantes à indiquer dans le formulaire ?",
    answer: "Les éléments essentiels sont l'adresse exacte de départ et d'arrivée, la date et l'heure, le nombre de passagers et de bagages, ainsi que le numéro de vol ou le nom de l'hôtel/villa si applicable. Plus votre demande est précise, plus le devis sera fiable."
  }
];

const breadcrumbItems = [
  { name: "Accueil", url: "/" },
  { name: "Réservation", url: "/reservation" }
];
---

<BaseLayout 
  title={title}
  description={description}
  currentPage="reservation"
  canonical={canonical}
>
  <SchemaOrg type="breadcrumb" breadcrumbItems={breadcrumbItems} />
  <SchemaOrg type="faq" faqItems={faqItems} />

    <nav class="breadcrumbs container" aria-label="Fil d’Ariane">
      <a href="/">Accueil</a> › <span>Réservation</span>
    </nav>

    <section class="section">
      <div class="container">
        <div class="section-header">
          <div class="section-eyebrow">Réservation en ligne</div>
          <h1 class="section-title">Réservez votre chauffeur privé en quelques étapes simples</h1>
          <p>Indiquez vos informations de trajet pour recevoir une proposition rapide (prix indicatif + confirmation de disponibilité) pour votre réservation VTC (Nice, Cannes, Monaco, Saint‑Tropez, aéroports Nice NCE &amp; Cannes‑Mandelieu…). Ce formulaire ne vous engage pas : aucun paiement en ligne n’est demandé, vous ne validez la réservation qu’après accord sur le devis. Les départs doivent être réservés au minimum 4 heures avant la prise en charge&nbsp;; pour les entreprises, une facturation mensuelle peut être étudiée sur demande.</p>
        </div>

        <!-- Message de succès/erreur -->
        <div id="form-message" class="form-message hidden" role="alert" aria-live="polite"></div>

        <div class="card">
          <form id="booking-form" class="booking-form" novalidate>
            <div class="form-row">
              <label for="depart">Adresse de départ *</label>
              <input id="depart" name="depart" type="text" required autocomplete="address-line1" placeholder="Ex: Aéroport Nice, 06200 Nice" data-google-places>
              <span class="form-error" id="depart-error" aria-live="polite"></span>
              <small class="form-hint">Autocomplétion activée si clé API Google configurée</small>
            </div>
            
            <div class="form-row">
              <label for="arrivee">Adresse d'arrivée *</label>
              <input id="arrivee" name="arrivee" type="text" required autocomplete="address-line2" placeholder="Ex: Hôtel Negresco, 37 Promenade des Anglais, Nice" data-google-places>
              <span class="form-error" id="arrivee-error" aria-live="polite"></span>
              <small class="form-hint">Autocomplétion activée si clé API Google configurée</small>
            </div>
            
            <div class="form-row">
              <label for="date">Date *</label>
              <input id="date" name="date" type="date" required min={new Date().toISOString().split('T')[0]}>
              <span class="form-error" id="date-error" aria-live="polite"></span>
            </div>
            
            <div class="form-row">
              <label for="heure">Heure *</label>
              <input id="heure" name="heure" type="time" required>
              <span class="form-error" id="heure-error" aria-live="polite"></span>
            </div>
            
            <div class="form-row">
              <label for="passagers">Nombre de passagers *</label>
              <input id="passagers" name="passagers" type="number" min="1" max="8" required>
              <span class="form-error" id="passagers-error" aria-live="polite"></span>
            </div>
            
            <div class="form-row">
              <label for="bagages">Nombre de bagages</label>
              <input id="bagages" name="bagages" type="number" min="0" max="12">
            </div>
            
            <div class="form-row">
              <label for="options">Options (siège enfant, bagage volumineux, étapes…)</label>
              <textarea id="options" name="options" rows="2" placeholder="ex. siège enfant, bagages volumineux, étape à Antibes…"></textarea>
            </div>
            
            <div class="form-row">
              <label for="telephone">Téléphone mobile *</label>
              <input id="telephone" name="telephone" type="tel" required autocomplete="tel" placeholder="06 12 34 56 78">
              <span class="form-error" id="telephone-error" aria-live="polite"></span>
            </div>
            
            <div class="form-row">
              <label for="email-reservation">Email de contact *</label>
              <input id="email-reservation" name="email" type="email" required placeholder="ex. 8888VTC@gmail.com" autocomplete="email">
              <span class="form-error" id="email-error" aria-live="polite"></span>
            </div>
            
            <div class="form-row">
              <label for="message">Précisions complémentaires</label>
              <textarea id="message" name="message" rows="3" placeholder="Numéro de vol, nom d'hôtel ou de villa, ville de retour, demandes particulières…"></textarea>
            </div>

            <div class="form-row">
              <label for="captcha">Question de vérification : 3 + 2 = ? *</label>
              <input id="captcha" name="captcha" type="text" required>
              <span class="form-error" id="captcha-error" aria-live="polite"></span>
            </div>

            <div class="form-row">
              <label>
                <input type="checkbox" name="rgpd" id="rgpd" required>
                Je consens à l'utilisation de mes données pour la gestion de ma demande de réservation, conformément à la <a href="/mentions-legales-rgpd" target="_blank" rel="noopener">politique de confidentialité</a>.
              </label>
              <span class="form-error" id="rgpd-error" aria-live="polite"></span>
            </div>

            <button class="btn-primary" type="submit" id="submit-btn">
              <span id="submit-text">Envoyer ma demande de réservation</span>
              <span id="submit-loading" class="hidden">Envoi en cours...</span>
            </button>
          </form>
        </div>

        <p class="hero-secondary text-secondary">En journée, une réponse vous est généralement apportée dans un délai court pour les demandes avec plus de 4 heures d’avance. Pour une demande à moins de 4 heures du départ (sans garantie de disponibilité), vous pouvez également appeler le <a href="tel:+33616552811">06 16 55 28 11</a> ou utiliser le bouton WhatsApp en bas à droite pour vérifier si un créneau est encore possible.</p>

        <section class="section section-spacing-sm">
          <h2>FAQ Réservation VTC</h2>
          <div class="faq-list">
            <div class="faq-item">
              <div class="faq-question">La demande de réservation m’engage‑t‑elle immédiatement&nbsp;?</div>
              <div class="faq-answer">
                <p>Non, le formulaire permet d’obtenir un prix indicatif et une confirmation de disponibilité. La réservation est réellement confirmée une fois que vous avez validé la proposition reçue (par téléphone, message ou retour écrit).</p>
              </div>
            </div>
            <div class="faq-item">
              <div class="faq-question">Sous quel délai vais‑je recevoir une réponse&nbsp;?</div>
              <div class="faq-answer">
                <p>Les demandes sont traitées le plus rapidement possible, en général dans un délai rapide pendant les horaires d’activité. Pour les demandes urgentes, l’appel téléphonique ou WhatsApp reste le canal prioritaire.</p>
              </div>
            </div>
            <div class="faq-item">
              <div class="faq-question">Puis‑je modifier une réservation déjà effectuée&nbsp;?</div>
              <div class="faq-answer">
                <p>Oui, dans la limite des disponibilités. En cas de changement d’heure, d’adresse ou de nombre de passagers, il suffit de reprendre contact dès que possible pour ajuster la réservation et, si besoin, le tarif.</p>
              </div>
            </div>
            <div class="faq-item">
              <div class="faq-question">Comment annuler un trajet réservé&nbsp;?</div>
              <div class="faq-answer">
                <p>L’annulation peut se faire en répondant au message de confirmation ou en contactant directement le chauffeur. Les conditions applicables sont précisées sur la page <a href="/tarifs">Tarifs</a> (politique d’annulation).</p>
              </div>
            </div>
            <div class="faq-item">
              <div class="faq-question">Quelles informations sont les plus importantes à indiquer dans le formulaire&nbsp;?</div>
              <div class="faq-answer">
                <p>Les éléments essentiels sont l'adresse exacte de départ et d'arrivée, la date et l'heure, le nombre de passagers et de bagages, ainsi que le numéro de vol ou le nom de l'hôtel/villa si applicable. Plus votre demande est précise, plus le devis sera fiable.</p>
              </div>
            </div>
            <div class="faq-item">
              <div class="faq-question">Comment réserver un chauffeur VTC Nice&nbsp;?</div>
              <div class="faq-answer">
                <p>Pour réserver un chauffeur VTC à Nice, utilisez notre <a href="/reservation">formulaire de réservation en ligne</a>, appelez-nous au <a href="tel:+33616552811">06 16 55 28 11</a> ou contactez-nous via WhatsApp. Indiquez votre adresse de départ, destination, date, heure et nombre de passagers. Réservation minimum 4h à l'avance recommandée.</p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </section>
</BaseLayout>

<script>
  // Autocomplétion Google Places (optionnel - nécessite clé API)
  function initGooglePlaces() {
    const apiKey = import.meta.env.PUBLIC_GOOGLE_PLACES_API_KEY;
    if (!apiKey) {
      if (import.meta.env.DEV) {
        console.log('Google Places API key not configured. Autocomplete disabled.');
      }
      return;
    }

    // Charger le script Google Places
    if (!window.google || !window.google.maps || !window.google.maps.places) {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&language=fr`;
      script.async = true;
      script.defer = true;
      script.onload = () => setupAutocomplete();
      document.head.appendChild(script);
    } else {
      setupAutocomplete();
    }
  }

  function setupAutocomplete() {
    const inputs = document.querySelectorAll('[data-google-places]');
    inputs.forEach(input => {
      const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['address', 'establishment'],
        componentRestrictions: { country: ['fr'] },
        fields: ['formatted_address', 'geometry', 'name', 'place_id']
      });

      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (place.formatted_address) {
          input.value = place.formatted_address;
        }
      });
    });
  }

  // Gestion du formulaire de réservation
  const form = document.getElementById('booking-form');
  const formMessage = document.getElementById('form-message');
  const submitBtn = document.getElementById('submit-btn');
  const submitText = document.getElementById('submit-text');
  const submitLoading = document.getElementById('submit-loading');

  // Initialiser Google Places au chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGooglePlaces);
  } else {
    initGooglePlaces();
  }

  // Initialiser Google Places au chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGooglePlaces);
  } else {
    initGooglePlaces();
  }

  if (!form) {
    if (import.meta.env.DEV) {
      console.error('Formulaire de réservation non trouvé');
    }
  } else {
    // Validation en temps réel
    const inputs = form.querySelectorAll('input[required], textarea[required]');
    inputs.forEach(input => {
      input.addEventListener('blur', () => validateField(input));
      input.addEventListener('input', () => clearError(input));
    });

    function validateField(field) {
      const errorId = `${field.id || field.name}-error`;
      const errorEl = document.getElementById(errorId);
      
      if (!field.checkValidity()) {
        showError(field, getErrorMessage(field));
        return false;
      }
      
      // Validation spécifique
      if (field.type === 'email' && !isValidEmail(field.value)) {
        showError(field, 'Email invalide');
        return false;
      }
      
      if (field.name === 'captcha' && field.value.trim() !== '5') {
        showError(field, 'Réponse incorrecte');
        return false;
      }
      
      if (field.name === 'date') {
        const selectedDate = new Date(field.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (selectedDate < today) {
          showError(field, 'La date ne peut pas être dans le passé');
          return false;
        }
      }
      
      if (field.name === 'telephone') {
        const phoneRegex = /^(?:(?:\+|00)33|0)\s*[1-9](?:[\s.-]*\d{2}){4}$/;
        if (!phoneRegex.test(field.value.replace(/\s/g, ''))) {
          showError(field, 'Format de téléphone invalide');
          return false;
        }
      }
      
      clearError(field);
      return true;
    }

    function getErrorMessage(field) {
      if (field.validity.valueMissing) return 'Ce champ est requis';
      if (field.validity.typeMismatch) return 'Format invalide';
      if (field.validity.rangeUnderflow) return `Minimum: ${field.min}`;
      if (field.validity.rangeOverflow) return `Maximum: ${field.max}`;
      return 'Valeur invalide';
    }

    function showError(field, message) {
      const errorId = `${field.id || field.name}-error`;
      const errorEl = document.getElementById(errorId);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
      field.classList.add('error');
    }

    function clearError(field) {
      const errorId = `${field.id || field.name}-error`;
      const errorEl = document.getElementById(errorId);
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.style.display = 'none';
      }
      field.classList.remove('error');
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Soumission du formulaire
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Validation complète
      let isValid = true;
      inputs.forEach(input => {
        if (!validateField(input)) {
          isValid = false;
        }
      });
      
      // Vérifier RGPD
      const rgpdCheckbox = form.querySelector('input[name="rgpd"]');
      if (!rgpdCheckbox.checked) {
        const rgpdError = document.getElementById('rgpd-error');
        if (rgpdError) {
          rgpdError.textContent = 'Vous devez accepter la politique de confidentialité';
          rgpdError.style.display = 'block';
        }
        isValid = false;
      } else {
        const rgpdError = document.getElementById('rgpd-error');
        if (rgpdError) {
          rgpdError.style.display = 'none';
        }
      }
      
      if (!isValid) {
        showMessage('Veuillez corriger les erreurs dans le formulaire', 'error');
        formMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      
      // Désactiver le bouton
      submitBtn.disabled = true;
      submitText.style.display = 'none';
      submitLoading.style.display = 'inline';
      
      // Préparer les données
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      try {
        const response = await fetch('/.netlify/functions/submit-booking', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data),
          signal: AbortSignal.timeout(30000) // Timeout 30s
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showMessage(result.message || 'Votre demande a été envoyée avec succès ! Vous recevrez une confirmation par email.', 'success');
          form.reset();
          
          // Scroll vers le message
          formMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Réinitialiser après 10 secondes
          setTimeout(() => {
            formMessage.style.display = 'none';
          }, 10000);
        } else {
          showMessage(result.error || 'Une erreur est survenue. Veuillez réessayer ou nous contacter directement.', 'error');
        }
      } catch (error) {
        if (import.meta.env.DEV) {
          console.error('Erreur:', error);
        }
        
        // Gestion d'erreurs améliorée
        let errorMessage = 'Une erreur est survenue. ';
        if (error.name === 'AbortError' || error.message?.includes('timeout')) {
          errorMessage += 'La requête a pris trop de temps. Veuillez réessayer.';
        } else if (error.message?.includes('network') || error.message?.includes('fetch')) {
          errorMessage += 'Problème de connexion. Vérifiez votre internet.';
        } else {
          errorMessage += 'Veuillez réessayer ou nous contacter directement au 06 16 55 28 11.';
        }
        
        showMessage(errorMessage, 'error');
      } finally {
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        submitLoading.style.display = 'none';
      }
    });
    
    function showMessage(message, type) {
      formMessage.textContent = message;
      formMessage.className = `form-message ${type}`;
      formMessage.style.display = 'block';
      formMessage.setAttribute('role', 'alert');
    }
  }
</script>

<style>
  .form-error {
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: none;
  }
  
  .form-message {
    padding: 1rem 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    font-weight: 500;
    animation: slideDown 0.3s ease;
  }
  
  .form-message.success {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid #22c55e;
    color: #22c55e;
  }
  
  .form-message.error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid #ef4444;
    color: #ef4444;
  }
  
  input.error,
  textarea.error {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
  }
  
  #submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
